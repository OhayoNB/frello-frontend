var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t={},a={},n=e.parcelRequired932;null==n&&((n=function(e){if(e in t)return t[e].exports;if(e in a){var n=a[e];delete a[e];var o={id:e,exports:{}};return t[e]=o,n.call(o.exports,o,o.exports),o.exports}var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){a[e]=t},e.parcelRequired932=n);var o=n("9kS2s"),r=n("6UCH9");const l={defaultLocale:"en",supportedLocales:["cs","de","en","es","fi","fr","hu","it","ja","nb","nl","pl","pt-BR","ru","sv","th","tr","uk","vi","zh-Hans","zh-Hant"],resourceUrl:"./strings/{locale}.f29ba279.json"};var c=n("grNVr");const i=window.TrelloPowerUp.util.makeErrorEnum("Slack",["Unauthorized","InvalidChannel","InvalidMessage","NoText","NotFound","RateLimited","Unknown","InvalidResponse","ServerError"]);const s={name:"Trello Slack App",key:(0,(r=n("6UCH9")).getClientId)(),scope:"read,write,account"};async function u(e){try{const t=await e.requestToken(s);return console.log("Successfully reset token for Slack Power-Up"),e.set("member","private","trelloToken",t),t}catch(e){console.error("Error resetting token for Slack Power-Up",e)}}const d={getToken:async function(e){const t=await e.get("member","private","trelloToken");return t||u(e)},resetToken:u},{sha256Digest:p}=window.TrelloPowerUp.util.crypto,m={401:i.Unauthorized,404:i.NotFound,500:i.ServerError};async function h(e,t,a={},n=!1){const o=await d.getToken(e);try{const c=await window.fetch(t,{...a,headers:{"Content-Type":"application/json",Authorization:o,...a?.headers}});if(c.ok){const e=c.headers.get("content-type")?.includes("application/json");return e?c.json():c.text()}if(403===c.status&&!n)return await d.resetToken(e),h(e,t,a,!0);throw r=c.status,l=await c.text()||c.statusText,new(m[r]||i.Unknown)(l)}catch(e){throw console.error(`Failed request "${t}"`,e),e}var r,l}async function g(e,t,a){if(a)try{const e=await p(t),a=window.localStorage.get(`slack:url:${e}`);if(a)return{formatted:a}}catch(e){}try{return await h(e,`/api/power-up/details-for-url?${new URLSearchParams({url:t,one:String(a)})}`)}catch(e){return console.error("Failed to get dataForUrl",e),{}}}async function y(e){try{return await h(e,"/api/power-up/members/me")}catch(e){return console.error("Failed to get myTeams",e),[]}}async function f(e,t){return h(e,`/api/power-up/slack/${t}/stars`)}async function w(e,t){const{conversations:a}=await h(e,`/api/power-up/slack/${t}/conversations`);return a}o=n("9kS2s");const k=e=>t=>y(t).then((a=>{if(!a?.length)return t.popup({title:t.localizeKey("authorize"),url:"./app.html?page=authorization",callback:t=>t.get("board","private","selected-slack").then((a=>e(t,{id:a})))});const n=[...a.map((a=>({...a,text:a.name,callback:n=>t.set("board","private","selected-slack",a.id).then((()=>e(n,a)))}))),{text:"Add Slack Workspace",callback:t=>t.popup({title:t.localizeKey("authorize"),url:"./app.html?page=authorization",callback:t=>t.get("board","private","selected-slack").then((a=>e(t,{id:a})))}),alwaysVisible:!0}];return t.popup({items:n,title:t.localizeKey("choose_slack_workspace"),search:{count:15}})})),_={},b={},z=e=>t=>Promise.all([t.get("board","private","selected-slack"),y(t)]).then((([a,n])=>{if(!n?.length)return t.popup({title:t.localizeKey("authorize"),url:"./app.html?page=authorization",callback:z(e)}),null;if(a){const e=n.find((({id:e})=>e===a));if(e)return e}return n[0]})).then((a=>{if(!a)return null;if(_[a.id])return _[a.id];if(b[a.id])return Promise.resolve(t.popup({items:b[a.id],title:t.localizeKey("choose_a_channel"),search:{count:15,placeholder:t.localizeKey("search_for_a_channel"),empty:t.localizeKey("no_channels_found")}}));const n=Promise.all([f(t,a.id),w(t,a.id)]).then((([n,o])=>{const r=o.map((t=>({...t,text:`${t.isPrivate?"ðŸ”’ ":"#"}${t.name}`,callback:n=>e(n,t,a)}))).sort(((e,t)=>{const a=n.find((t=>t.channel===e.id)),o=n.find((e=>e.channel===t.id));return a&&!o?-1:!a&&o?1:e.name.toLowerCase()<t.name.toLowerCase()?-1:e.name.toLowerCase()>t.name.toLowerCase()?1:0})),l={text:t.localizeKey("choose_a_different_workspace"),callback:k(z(e)),alwaysVisible:!0};return r.push(l),b[a.id]=r,_[a.id]=null,t.popup({items:r,title:t.localizeKey("choose_a_channel"),search:{count:15,placeholder:t.localizeKey("search_for_a_channel"),empty:t.localizeKey("no_channels_found")}})}));return _[a.id]=n,n}));var v=n("j5Znf");const U=e=>async t=>{const[a,n]=await Promise.all([t.get("board","private","selected-slack"),y(t)]);if(!n?.length)return t.popup({title:t.localizeKey("authorize"),url:"./app.html?page=authorization",callback:U(e)}),null;const o=(a&&n.find((({id:e})=>e===a)))??n[0];if(!o)return null;const r=await async function(e,t){return h(e,`/api/power-up/slack/${t}/members`)}(t,o.id),l=r.map((a=>({text:(0,v.getUserDisplayName)(a,t),callback:t=>e(t,a,o)}))),c={text:t.localizeKey("choose_a_different_workspace"),callback:k(U(e)),alwaysVisible:!0};return l.push(c),t.popup({items:l,title:t.localizeKey("choose_user_ellipsis"),search:{count:15,placeholder:t.localizeKey("search_for_a_user"),empty:t.localizeKey("no_users_found")}})};v=n("j5Znf");const K=(e,t,a)=>n=>n.card("name","url").then((o=>{let r=a;/^(in|on|every)/.test(a)||(r=/minutes|hours|days|months/.test(a)?`in ${a}`:`on ${a}`);const l=n.localizeKey("check_on_card",{card:`*<${o.url}|${o.name}>*`});return async function(e,t,a,n,o){return h(e,`/api/power-up/remind/${t}`,{method:"POST",body:JSON.stringify({idSlackTeam:a,message:n,time:o})})}(n,e.id,t.id,l,r)})).then((()=>{const t=n.localizeKey("slack_will_remind_name",{name:"me"===e.id?"you":e.name??(0,v.getUserDisplayName)(e)});return n.popup({title:n.localizeKey("reminder_set"),url:"app.html?page=reminder-set",args:{message:t,success:!0,target:e}})})).catch((t=>n.popup({title:n.localizeKey("unable_to_set_reminder"),url:"app.html?page=reminder-set",args:{message:n.localizeKey("error_setting_reminder",{error:t.message}),success:!1,target:e}})));v=n("j5Znf");function S(e,t){(0,o.sendUIEvent)({action:"clicked",actionSubject:"button",actionSubjectId:t,source:"cardDetailScreen"},e)}async function x(e,t,a){const n=await e.card("id");if(await async function(e,t,a,n){return h(e,`/api/power-up/send/${t}`,{method:"POST",body:JSON.stringify({idSlackTeam:a,idTarget:n})})}(e,n.id,a.id,t.id),t.id.startsWith("C")||t.id.startsWith("G")){const n={target:t,team:a};e.set("board","private","last-channel",n)}e.popup({title:e.localizeKey("message_sent"),url:"app.html?page=message-sent",args:{target:t,team:a}})}const T=(e,t)=>a=>a.popup({title:a.localizeKey("choose_a_time"),url:"choose-time.html",args:{target:e,team:t}});function P(e,t,a){const n=e.localizeKeys(["three_minutes","ten_minutes","one_hour","three_hours","one_day","two_days","three_days","seven_days","fourteen_days","thirty_days"]);return e.popup({title:"me"===t.name?e.localizeKey("remind_you_when"):e.localizeKey("remind_name_when",{name:t.name??(0,v.getUserDisplayName)(t)}),items:[{text:e.localizeKey("choose_a_time_ellipsis"),callback:T(t,a)},...["3 minutes","10 minutes","1 hour","3 hours","1 day","2 days","3 days","7 days","14 days","30 days"].map(((o,r)=>({text:e.localizeKey("remind_in_interval",{interval:n[r]}),callback:K(t,a,`in ${o}`)})))]})}function N(e,t){return P(e,{name:"me",id:"me"},t)}async function $(e){const t=await e.get("board","private","last-channel");S(e,"slackPowerUpCardButton");const a=[t?.target?.name&&{text:e.localizeKey("send_to_specific_channel",{channel:t.target.name,isPrivate:t.target.isPrivate?"ðŸ”’ ":"#"}),callback:a=>y(a).then((n=>n.some((e=>e.id===t.team.id))?x(a,t.target,t.team):a.popup({title:e.localizeKey("authorize"),url:"./app.html?page=authorization",callback:e=>e.back()})))},{text:e.localizeKey("send_to_channel"),callback:e=>(S(e,"slackPowerUpSendToChannelButton"),z(x)(e))},{text:e.localizeKey("send_via_direct_message"),callback:e=>(S(e,"slackPowerUpSendDMButton"),U(x)(e))},{text:e.localizeKey("attach_conversation_ellipsis"),callback:e=>(S(e,"slackPowerUpAttachConversationButton"),function(e){e.popup({title:e.localizeKey("attach_conversation"),url:"attach-conversation.html"})}(e))},{text:e.localizeKey("remind_me_about_card"),callback:e=>(S(e,"slackPowerUpRemindMeButton"),k(N)(e))},{text:e.localizeKey("remind_someone_about_card"),callback:e=>(S(e,"slackPowerUpRemindSomeoneButton"),U(P)(e))},{text:e.localizeKey("remind_channel_about_card"),callback:e=>(S(e,"slackPowerUpRemindChannelButton"),z(P)(e))}].filter(Boolean);return e.popup({items:a,title:e.localizeKey("slack")})}var C=n("5I9kH");function L(e,t){return e.length>t?`${e.slice(0,t).replace(/\s*\S+$/,"")}â€¦`:e}const R=window.outerHeight-200,j=R>625?R:625;function E(e){return"production"===r.environment?e:"staging"===r.environment?`${e} (stg-east)`:`${e} (unknown)`}const H={accentColor:"#425381",url:"app.html?page=settings",title:E("Slack"),height:j},I=`https://${window.location.hostname}/power-up/images/icon.svg`,{sha256Digest:B}=window.TrelloPowerUp.util.crypto;window.TrelloPowerUp.initialize({"attachment-sections":(e,t)=>{const a=t.entries.filter((e=>C.slackUrls.isMessage(e.url)));return 0===a.length?[]:((0,o.sendUIEvent)({action:"viewed",actionSubject:"section",actionSubjectId:"slackPowerUpSection",source:"cardDetailScreen"},e),[{claimed:a,icon:I,title:E(e.localizeKey("slack_conversations")),content:{type:"iframe",url:e.signUrl("./messages.html"),height:64}}])},"board-buttons":e=>[{icon:I,text:E(e.localizeKey("slack")),callback:t=>{(0,o.sendUIEvent)({action:"clicked",actionSubject:"button",actionSubjectId:"slackPowerUpBoardButton",source:"boardScreen"},e),t.modal(H)}}],"card-buttons":e=>[{icon:I,text:E(e.localizeKey("slack")),callback:$}],"card-from-url":async(e,t)=>{const{url:a}=t;if(!C.slackUrls.isMessage(t.url))throw e.NotHandled("Not a Slack message URL");return g(e,a,!0).catch((()=>{throw e.NotHandled("Error getting data for URL")})).then((t=>{if(t&&t.formatted)return{name:L(t.formatted,128),desc:t.formatted};if(t&&t.messages.length>0){const n=t.messages[0].text||t.messages[0].attachments[0].fallback;return c.msgFormatter.getMessageText(e,n,t).then((async e=>{try{const t=await B(a);localStorage.setItem(`slack:url:${t}`,e)}catch(e){}return{name:L(e,128),desc:e}})).catch((()=>{throw e.NotHandled("Error formatting message")}))}throw e.NotHandled("No data for URL")}))},"format-url":async(e,t)=>{if(!C.slackUrls.isMessage(t.url))throw e.NotHandled("Not a Slack message URL");const a=/archives\/(.*)\//g.exec(t.url)[1];return/^[D|G]/g.test(a)?{text:t.url,icon:I}:g(e,t.url,!0).catch((()=>{throw e.NotHandled("Error getting data for URL")})).then((a=>{if(a?.formatted)return{text:L(a.formatted,128),icon:I};if(a?.messages?.length){const n=a.messages[0].text||a.messages[0].attachments[0].fallback;return c.msgFormatter.getMessageText(e,n,a).then((async e=>{try{const a=await B(t.url);localStorage.setItem(`slack:url:${a}`,e)}catch(e){}return{text:L(e,128),icon:I}})).catch((()=>{throw e.NotHandled("Error formatting message")}))}throw e.NotHandled("No data for URL")}))},"show-settings":e=>e.modal(H)},{targetOrigin:(0,r.getTargetOrigin)(),localization:l,Sentry:window.Sentry});
//# sourceMappingURL=index.e7826fff.js.map
